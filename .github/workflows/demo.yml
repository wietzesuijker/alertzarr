name: Demo AlertZarr

on:
  workflow_dispatch:
    inputs:
      alert:
        description: Sample alert path under data/sample_alerts/
        required: true
        default: copernicus_flood.json
      hazard:
        description: Hazard type label
        required: true
        default: flood
      run-scene-search:
        description: Include Sentinel scene search (requires internet)
        type: boolean
        default: true
      conversion-mode:
        description: Conversion mode passed to alertzarr (auto, real, simulate)
        required: true
        default: real
        type: choice
        options:
          - auto
          - real
          - simulate
      titiler-base-url:
        description: Optional TiTiler base URL (leave blank to skip viewer links)
        required: false
        default: ""
      titiler-tile-matrix-set:
        description: TileMatrixSet id used when composing TileJSON URLs
        required: false
        default: WebMercatorQuad

jobs:
  demo:
    runs-on: ubuntu-latest
    services:
      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      RABBITMQ_URL: amqp://guest:guest@localhost:5672/
      MINIO_ENDPOINT: http://localhost:9000
      MINIO_ACCESS_KEY: autopilot
      MINIO_SECRET_KEY: autopilot123
      MINIO_REGION: us-east-1
      GEOZARR_BUCKET: autopilot-geozarr
      STAC_BUCKET: autopilot-stac
      REAL_CONVERSION_ENABLED: "true"
      EODC_STAC_API: https://stac.core.eopf.eodc.eu
      EODC_S3_ENDPOINT: https://s3.de.io.cloud.ovh.net
      EODC_S3_REGION: gra
      TITILER_BASE_URL: ${{ inputs.titiler-base-url }}
      TITILER_TILE_MATRIX_SET: ${{ inputs.titiler-tile-matrix-set }}
    steps:
      - uses: actions/checkout@v4

      - name: Start MinIO service
        run: |
          docker run -d \
            --name minio \
            -p 9000:9000 \
            -e MINIO_ROOT_USER=autopilot \
            -e MINIO_ROOT_PASSWORD=autopilot123 \
            minio/minio server /data
          for i in {1..20}; do
            if curl -sf http://localhost:9000/minio/health/ready >/dev/null; then
              echo "MinIO is ready"
              exit 0
            fi
            sleep 3
          done
          echo "MinIO failed to start" >&2
          docker logs minio >&2 || true
          exit 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: |
          uv sync
          uv sync --group dev

      - name: Seed MinIO buckets
        run: uv run python infra/bootstrap_minio.py

      - name: Run AlertZarr pipeline
        run: |
          SCENE_FLAG=""
          if [ "${{ inputs.run-scene-search }}" != "true" ]; then
            SCENE_FLAG="--no-scene-search"
          fi
          uv run alertzarr \
            --alert ${{ inputs.alert }} \
            --hazard ${{ inputs.hazard }} \
            --conversion-mode ${{ inputs.conversion-mode }} \
            $SCENE_FLAG

      - name: Upload run report
        uses: actions/upload-artifact@v4
        with:
          name: alertzarr-run-report
          path: local/run_reports/*.json

      - name: Download STAC item from MinIO
        id: pull-stac
        if: always()
        run: |
          mkdir -p artifacts/stac
          python <<'PY'
import os
import pathlib
import boto3

endpoint = os.environ["MINIO_ENDPOINT"]
aws_access_key_id = os.environ["MINIO_ACCESS_KEY"]
aws_secret_access_key = os.environ["MINIO_SECRET_KEY"]
region_name = os.environ["MINIO_REGION"]
bucket = os.environ["STAC_BUCKET"]
dest = pathlib.Path("artifacts/stac")

s3 = boto3.client(
    "s3",
    endpoint_url=endpoint,
    aws_access_key_id=aws_access_key_id,
    aws_secret_access_key=aws_secret_access_key,
    region_name=region_name,
)

paginator = s3.get_paginator("list_objects_v2")
downloaded = 0
for page in paginator.paginate(Bucket=bucket, Prefix="items/"):
    for obj in page.get("Contents", []):
        key = obj["Key"]
        if not key.endswith(".json"):
            continue
        target = dest / os.path.basename(key)
        s3.download_file(bucket, key, target.as_posix())
        downloaded += 1

print(f"Downloaded {downloaded} STAC item(s) to {dest}")
with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
    fh.write(f"count={downloaded}\n")
PY

      - name: Upload generated STAC items
        if: always() && steps.pull-stac.outputs.count != '0'
        uses: actions/upload-artifact@v4
        with:
          name: alertzarr-stac-items
          path: artifacts/stac/*.json

      - name: Stop MinIO service
        if: always()
        run: docker rm -f minio || true
