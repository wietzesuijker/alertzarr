name: Demo AlertZarr

on:
  workflow_dispatch:
    inputs:
      alert:
        description: Sample alert path under data/sample_alerts/
        required: true
        default: copernicus_flood.json
      hazard:
        description: Hazard type label
        required: true
        default: flood
      run-scene-search:
        description: Include Sentinel scene search (requires internet)
        type: boolean
        default: true
      conversion-mode:
        description: Conversion mode passed to alertzarr (auto, real, simulate)
        required: true
        default: real
        type: choice
        options:
          - auto
          - real
          - simulate
      titiler-base-url:
        description: TiTiler base URL used for viewer links
        required: true
        default: http://localhost:8080
      titiler-tile-matrix-set:
        description: TileMatrixSet id used when composing TileJSON URLs
        required: false
        default: WebMercatorQuad

jobs:
  demo:
    runs-on: ubuntu-latest
    services:
      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      RABBITMQ_URL: amqp://guest:guest@localhost:5672/
      MINIO_ENDPOINT: http://localhost:9000
      MINIO_ACCESS_KEY: autopilot
      MINIO_SECRET_KEY: autopilot123
      MINIO_REGION: us-east-1
      GEOZARR_BUCKET: autopilot-geozarr
      STAC_BUCKET: autopilot-stac
      STAC_PUBLIC_BASE_URL: https://demo.alertzarr.dev/stac
      REAL_CONVERSION_ENABLED: "true"
      EODC_STAC_API: https://stac.core.eopf.eodc.eu
      EODC_S3_ENDPOINT: https://s3.de.io.cloud.ovh.net
      EODC_S3_REGION: gra
      TITILER_BASE_URL: ${{ inputs.titiler-base-url }}
      TITILER_TILE_MATRIX_SET: ${{ inputs.titiler-tile-matrix-set }}
    steps:
      - uses: actions/checkout@v4

      - name: Start MinIO service
        run: |
          docker run -d \
            --name minio \
            -p 9000:9000 \
            -e MINIO_ROOT_USER=autopilot \
            -e MINIO_ROOT_PASSWORD=autopilot123 \
            minio/minio server /data
          for i in {1..20}; do
            if curl -sf http://localhost:9000/minio/health/ready >/dev/null; then
              echo "MinIO is ready"
              exit 0
            fi
            sleep 3
          done
          echo "MinIO failed to start" >&2
          docker logs minio >&2 || true
          exit 1

      - name: Start TiTiler service
        run: |
          docker run -d \
            --name titiler \
            --add-host=host.docker.internal:host-gateway \
            -p 8080:80 \
            -e AWS_ACCESS_KEY_ID=autopilot \
            -e AWS_SECRET_ACCESS_KEY=autopilot123 \
            -e AWS_DEFAULT_REGION=us-east-1 \
            -e AWS_ENDPOINT_URL=http://host.docker.internal:9000 \
            -e TITILER_EOPF_STORE_URL=s3://autopilot-geozarr/ \
            -e TITILER_EOPF_API_CORS_ORIGINS=* \
            ghcr.io/eopf-explorer/titiler-eopf:latest
          for i in {1..20}; do
            if curl -sf http://localhost:8080/_mgmt/ping >/dev/null; then
              echo "TiTiler is ready"
              exit 0
            fi
            sleep 3
          done
          echo "TiTiler failed to start" >&2
          docker logs titiler >&2 || true
          exit 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "0.4.x"

      - name: Cache uv downloads
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-demo-${{ hashFiles('pyproject.toml', 'uv.lock') }}

      - name: Install dependencies
        run: uv sync --group dev

      - name: Seed MinIO buckets
        run: uv run python infra/bootstrap_minio.py

      - name: Run AlertZarr pipeline
        run: |
          SCENE_FLAG=""
          if [ "${{ inputs.run-scene-search }}" != "true" ]; then
            SCENE_FLAG="--no-scene-search"
          fi
          uv run alertzarr \
            --alert ${{ inputs.alert }} \
            --hazard ${{ inputs.hazard }} \
            --conversion-mode ${{ inputs.conversion-mode }} \
            $SCENE_FLAG

      - name: Upload run report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: alertzarr-run-report
          path: local/run_reports/*.json
          if-no-files-found: warn

      - name: Download STAC items from MinIO
        id: pull-stac
        if: always()
        run: |
          set -euo pipefail
          mkdir -p artifacts/stac
          uv run python scripts/download_stac_items.py --dest artifacts/stac
          COUNT=$(find artifacts/stac -maxdepth 1 -name '*.json' -print | wc -l | tr -d ' ')
          echo "Downloaded $COUNT STAC item(s)"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Upload generated STAC items
        if: ${{ always() && steps.pull-stac.outputs.count != '0' }}
        uses: actions/upload-artifact@v4
        with:
          name: alertzarr-stac-items
          path: artifacts/stac/*.json

      - name: Stop services
        if: always()
        run: |
          docker rm -f titiler || true
          docker rm -f minio || true
